---
name: troubleshoot
description: Answer questions about pipeline results, drops, removals, and why certain items can or cannot be deleted. Use when the user asks why something was dropped, why something wasn't dropped, what the Value column is, why LocalDateTable columns remain, or any question about the optimization/cleanup output.
---

# Troubleshoot Pipeline Results

## What This Skill Does
Answers user questions about the pipeline output — why items were flagged for removal, why certain items could NOT be removed, and how to interpret the results.

## When to Use
- User asks "why was X dropped?" or "why wasn't X dropped?"
- User asks about Value columns, LocalDateTable columns, or date hierarchies
- User asks what the DROP SQL does or what MODEL_CLEANUP contains
- User asks about protected items (views, security tables, hierarchy columns)
- User asks about the difference between DROP SQL and TMDL cleanup
- User sees unexpected results in the pipeline output

## Common Questions & Answers

### "Why does the Value column still show in PBI?"
The `Value` column in measure-only tables (e.g., "0.01 Key Metrics") is auto-generated by PBI Desktop from the `partition source = {0}` expression. The TMDL cleanup removes the explicit `column Value` block, but PBI regenerates it at runtime. This is a structural PBI requirement — the column cannot be fully eliminated as long as the table exists.

### "Why can't LocalDateTable columns be removed?"
LocalDateTable columns (Year, MonthNo, Month, QuarterNo, Quarter, Day) support the date hierarchy drill-down (Year > Quarter > Month > Day). They are protected because:
1. Kept date columns (e.g., `DateTable.Date`) have **variation** sub-blocks pointing to the LocalDateTable's **Date Hierarchy**
2. That hierarchy references level columns: Year, Quarter, Month, Day
3. Month has `sortByColumn: MonthNo`, Quarter has `sortByColumn: QuarterNo`
4. Removing ANY link in this chain crashes PBI Desktop

These columns appear as "unused calculated columns" in pipeline re-runs — this is expected and correct.

### "Why was column X dropped / not dropped?"
To investigate, check the Function5 output:
```python
import pandas as pd
f5 = pd.read_excel("output/<project>/Function5_Output.xlsx")
row = f5[f5["ColumnName"].str.strip() == "X"]
print(row[["TableName", "ColumnName", "Used_in_PBI", "Used_in_Relationship", "Protected", "Remove_column"]])
```
- `Used_in_PBI = 1` → column is used in a report visual, filter, or measure
- `Used_in_Relationship = 1` → column participates in a model relationship
- `Protected = Yes` → column is in a view or security table (manually protected)
- `Remove_column = Yes` → column is flagged for removal (both flags = 0 and not protected)

### "What's the difference between DROP SQL and TMDL cleanup?"
- **DROP SQL** (`DROP_COLUMNS.sql`, `DROP_TABLES.sql`) — for **imported columns** that exist in the database. Run these against your SQL Server/data warehouse to physically remove the data.
- **TMDL cleanup** — for **all item types** (measures, calculated columns, imported columns) in the semantic model definition files. This edits the `.tmdl` source files directly.
- Imported columns need BOTH: DROP SQL to remove from the database AND TMDL cleanup to remove from the model definition.
- Measures and calculated columns only need TMDL cleanup (they don't exist in the database).

### "Why was a whole table not dropped?"
A table is only flagged for removal (Function6) when ALL its columns have `Remove_column = Yes`. If even one column is used in PBI, in a relationship, or is protected, the table stays.

### "How do I restore after TMDL cleanup?"
Every edited `.tmdl` file has a `.tmdl.bak` backup alongside it. To restore:
```bash
cd <semantic-model>/definition/tables
for f in *.tmdl.bak; do cp "$f" "${f%.bak}"; done
```

## How to Investigate
When answering user questions about drops, read the relevant output files:
1. `Function5_Output.xlsx` — per-column removal flags (the source of truth)
2. `Function6_Output.xlsx` — per-table removal flags
3. `Function3_Output.xlsx` — Used_in_PBI flags
4. `Function4_Output.xlsx` — Used_in_Relationship flags
5. `TMDL_CLEANUP_REPORT.xlsx` — what was actually removed/skipped from TMDL files
6. `DROP_COLUMNS.sql` / `DROP_TABLES.sql` — generated SQL statements
